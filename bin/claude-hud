#!/bin/bash
#
# claude-hud - Start Claude Code sessions with HUD monitoring
#
# Usage:
#   hud <project>                          # Single session in new window
#   hud <project1> <project2> ...          # Multi-pane grid layout
#   hud 3                                  # Create 3 empty panes (no claude)
#   hud ~/project -- -c                    # Pass args to claude (continue)
#   hud ~/project -- --model opus          # Use specific model
#

set -e

PROFILE_NAME="ClaudeHUD-Idle"
STATE_DIR="$HOME/.claude-hud"

# Parse arguments
PROJECTS=()
CLAUDE_ARGS=""
MONO_MODE=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --)
            # Everything after -- goes to claude
            shift
            CLAUDE_ARGS="$*"
            break
            ;;
        --mono|-m)
            MONO_MODE=true
            shift
            ;;
        --help|-h)
            echo "Usage: hud <project> [project2] ... [-- CLAUDE_ARGS]"
            echo "       hud <number>                        # Create empty panes"
            echo ""
            echo "Options:"
            echo "  --mono, -m           Use monochrome color scheme"
            echo "  --                   Pass remaining args to claude"
            echo "  --help, -h           Show this help"
            echo ""
            echo "Examples:"
            echo "  hud ~/myproject                      # Single session"
            echo "  hud ~/api ~/web ~/db                 # 3-pane grid"
            echo "  hud --mono ~/api ~/web ~/db          # Monochrome mode"
            echo "  hud 4                                # 4 empty panes"
            echo "  hud ~/project -- -c                  # Continue session"
            echo "  hud ~/project -- --model opus        # Use opus model"
            echo "  hud ~/project -- -r                  # Resume picker"
            exit 0
            ;;
        -*)
            echo "Unknown option: $1"
            exit 1
            ;;
        *)
            PROJECTS+=("$1")
            shift
            ;;
    esac
done

# Ensure state directory exists
mkdir -p "$STATE_DIR"

# Check if single numeric argument (empty panes mode)
EMPTY_PANES=0
if [ ${#PROJECTS[@]} -eq 1 ] && [[ "${PROJECTS[0]}" =~ ^[1-8]$ ]]; then
    EMPTY_PANES="${PROJECTS[0]}"
fi

# Validate input
if [ ${#PROJECTS[@]} -lt 1 ]; then
    echo "Error: At least one project path or pane count required"
    echo "Usage: hud [OPTIONS] <project> [project2] ..."
    echo "       hud <number>  # Create empty panes (1-8)"
    exit 1
fi

# Project color palette (RGB values scaled for AppleScript: value * 257)
get_project_color() {
    local index=$1

    if [ "$MONO_MODE" = true ]; then
        # Monochrome: shades of dark blue-grey
        case $index in
            0) echo "{5140, 6168, 8224}" ;;    # Darkest blue-grey
            1) echo "{6168, 7196, 9252}" ;;    # Slightly lighter
            2) echo "{5654, 6682, 8738}" ;;    # Medium shade
            3) echo "{6682, 7710, 9766}" ;;    # Lighter
            4) echo "{5397, 6425, 8481}" ;;    # Medium-dark
            5) echo "{6939, 7967, 10023}" ;;   # Lightest
            6) echo "{5911, 6939, 8995}" ;;    # Medium blue-grey
            7) echo "{6425, 7453, 9509}" ;;    # Light blue-grey
            *) echo "{5140, 6168, 8224}" ;;    # Default
        esac
    else
        # Multi-color: Porsche PTS inspired palette
        case $index in
            0) echo "{19018, 5397, 24672}" ;;   # Ultra Violet
            1) echo "{0, 27242, 35466}" ;;      # Mexico Blue
            2) echo "{13621, 28784, 12336}" ;;  # Viper Green
            3) echo "{45232, 24672, 9509}" ;;   # Gulf Orange
            4) echo "{35466, 10280, 22616}" ;;  # Ruby Star
            5) echo "{11822, 22616, 37008}" ;;  # Navy
            6) echo "{27499, 20560, 39835}" ;;  # Violet
            7) echo "{9509, 34181, 9509}" ;;     # Signal Green
            *) echo "{19018, 5397, 24672}" ;;   # Default to Ultra Violet
        esac
    fi
}

# Truncate badge text
truncate_badge() {
    local name="$1"
    if [ ${#name} -gt 12 ]; then
        echo "${name:0:12}..."
    else
        echo "$name"
    fi
}

#
# EMPTY PANES MODE - Create grid without running Claude
#
run_empty_grid() {
    local count=$1

    SCRIPT=$(cat <<HEADER
tell application "iTerm2"
    set newWindow to (create window with profile "$PROFILE_NAME")
    set bounds of newWindow to {100, 100, 1500, 1000}
    set windowId to id of newWindow

    tell newWindow
HEADER
)

    # First session (top-left)
    local color0=$(get_project_color 0)
    SCRIPT+="
        tell current session
            set background color to $color0
            set variable named \"user.badge\" to \"Pane 1\"
        end tell"

    # Pane 2: split pane 1 vertically (column 2)
    if [ $count -ge 2 ]; then
        local color1=$(get_project_color 1)
        SCRIPT+="
        tell current session
            set session2 to (split vertically with profile \"$PROFILE_NAME\")
        end tell
        tell session2
            set background color to $color1
            set variable named \"user.badge\" to \"Pane 2\"
        end tell"
    fi

    # Pane 3: split pane 2 vertically (column 3)
    if [ $count -ge 3 ]; then
        local color2=$(get_project_color 2)
        SCRIPT+="
        tell session2
            set session3 to (split vertically with profile \"$PROFILE_NAME\")
        end tell
        tell session3
            set background color to $color2
            set variable named \"user.badge\" to \"Pane 3\"
        end tell"
    fi

    # Pane 7: split pane 3 vertically BEFORE horizontal splits (column 4, full height)
    if [ $count -ge 7 ]; then
        local color6=$(get_project_color 6)
        SCRIPT+="
        tell session3
            set session7 to (split vertically with profile \"$PROFILE_NAME\")
        end tell
        tell session7
            set background color to $color6
            set variable named \"user.badge\" to \"Pane 7\"
        end tell"
    fi

    # Pane 4: split pane 1 horizontally (row 2, column 1)
    if [ $count -ge 4 ]; then
        local color3=$(get_project_color 3)
        SCRIPT+="
        tell first session of current tab
            set session4 to (split horizontally with profile \"$PROFILE_NAME\")
        end tell
        tell session4
            set background color to $color3
            set variable named \"user.badge\" to \"Pane 4\"
        end tell"
    fi

    # Pane 5: split pane 2 horizontally (row 2, column 2)
    if [ $count -ge 5 ]; then
        local color4=$(get_project_color 4)
        SCRIPT+="
        tell session2
            set session5 to (split horizontally with profile \"$PROFILE_NAME\")
        end tell
        tell session5
            set background color to $color4
            set variable named \"user.badge\" to \"Pane 5\"
        end tell"
    fi

    # Pane 6: split pane 3 horizontally (row 2, column 3)
    if [ $count -ge 6 ]; then
        local color5=$(get_project_color 5)
        SCRIPT+="
        tell session3
            set session6 to (split horizontally with profile \"$PROFILE_NAME\")
        end tell
        tell session6
            set background color to $color5
            set variable named \"user.badge\" to \"Pane 6\"
        end tell"
    fi

    # Pane 8: split pane 7 horizontally (column 4, bottom)
    if [ $count -ge 8 ]; then
        local color7=$(get_project_color 7)
        SCRIPT+="
        tell session7
            set session8 to (split horizontally with profile \"$PROFILE_NAME\")
        end tell
        tell session8
            set background color to $color7
            set variable named \"user.badge\" to \"Pane 8\"
        end tell"
    fi

    SCRIPT+="
    end tell
    return windowId
end tell"

    # Run the AppleScript
    osascript -e "$SCRIPT" 2>/dev/null
    echo "Created $count empty panes"
}

# Handle empty panes mode
if [ $EMPTY_PANES -gt 0 ]; then
    run_empty_grid $EMPTY_PANES
    exit 0
fi

# Resolve all paths to absolute
RESOLVED_PROJECTS=()
PROJECT_NAMES=()
for p in "${PROJECTS[@]}"; do
    if [[ "$p" != /* ]]; then
        resolved="$(cd "$p" 2>/dev/null && pwd)" || {
            echo "Error: Cannot access path: $p"
            exit 1
        }
    else
        resolved="$p"
    fi
    RESOLVED_PROJECTS+=("$resolved")
    PROJECT_NAMES+=("$(basename "$resolved")")
done

NUM_PROJECTS=${#RESOLVED_PROJECTS[@]}

#
# SINGLE PROJECT MODE
#
run_single_session() {
    local project="${RESOLVED_PROJECTS[0]}"
    local name="${PROJECT_NAMES[0]}"
    local badge=$(truncate_badge "$name")
    local color=$(get_project_color 0)

    osascript -e "
tell application \"iTerm2\"
    set newWindow to (create window with profile \"$PROFILE_NAME\")
    set bounds of newWindow to {100, 100, 1500, 1000}
    tell current session of newWindow
        write text \"cd '$project' && claude $CLAUDE_ARGS\"
        set name to \"○ $name\"
        set background color to $color
        set variable named \"user.badge\" to \"$badge\"
    end tell
end tell"
    echo "Started Claude HUD: $name"
}

#
# MULTI-PROJECT GRID MODE
#
run_grid() {
    local projects=("${RESOLVED_PROJECTS[@]}")
    local names=("${PROJECT_NAMES[@]}")
    local count=${#projects[@]}

    SCRIPT=$(cat <<HEADER
tell application "iTerm2"
    set newWindow to (create window with profile "$PROFILE_NAME")
    set bounds of newWindow to {100, 100, 1500, 1000}
    set windowId to id of newWindow

    tell newWindow
HEADER
)

    # First session (top-left)
    local badge0=$(truncate_badge "${names[0]}")
    local color0=$(get_project_color 0)
    SCRIPT+="
        tell current session
            write text \"cd '${projects[0]}' && claude $CLAUDE_ARGS\"
            set name to \"○ ${names[0]}\"
            set background color to $color0
            set variable named \"user.badge\" to \"$badge0\"
        end tell"

    # Pane 2: split pane 1 vertically (column 2)
    if [ $count -ge 2 ]; then
        local badge1=$(truncate_badge "${names[1]}")
        local color1=$(get_project_color 1)
        SCRIPT+="
        tell current session
            set session2 to (split vertically with profile \"$PROFILE_NAME\")
        end tell
        tell session2
            write text \"cd '${projects[1]}' && claude $CLAUDE_ARGS\"
            set name to \"○ ${names[1]}\"
            set background color to $color1
            set variable named \"user.badge\" to \"$badge1\"
        end tell"
    fi

    # Pane 3: split pane 2 vertically (column 3)
    if [ $count -ge 3 ]; then
        local badge2=$(truncate_badge "${names[2]}")
        local color2=$(get_project_color 2)
        SCRIPT+="
        tell session2
            set session3 to (split vertically with profile \"$PROFILE_NAME\")
        end tell
        tell session3
            write text \"cd '${projects[2]}' && claude $CLAUDE_ARGS\"
            set name to \"○ ${names[2]}\"
            set background color to $color2
            set variable named \"user.badge\" to \"$badge2\"
        end tell"
    fi

    # Pane 7: split pane 3 vertically BEFORE horizontal splits (column 4, full height)
    if [ $count -ge 7 ]; then
        local badge6=$(truncate_badge "${names[6]}")
        local color6=$(get_project_color 6)
        SCRIPT+="
        tell session3
            set session7 to (split vertically with profile \"$PROFILE_NAME\")
        end tell
        tell session7
            write text \"cd '${projects[6]}' && claude $CLAUDE_ARGS\"
            set name to \"○ ${names[6]}\"
            set background color to $color6
            set variable named \"user.badge\" to \"$badge6\"
        end tell"
    fi

    # Pane 4: split pane 1 horizontally (row 2, column 1)
    if [ $count -ge 4 ]; then
        local badge3=$(truncate_badge "${names[3]}")
        local color3=$(get_project_color 3)
        SCRIPT+="
        tell first session of current tab
            set session4 to (split horizontally with profile \"$PROFILE_NAME\")
        end tell
        tell session4
            write text \"cd '${projects[3]}' && claude $CLAUDE_ARGS\"
            set name to \"○ ${names[3]}\"
            set background color to $color3
            set variable named \"user.badge\" to \"$badge3\"
        end tell"
    fi

    # Pane 5: split pane 2 horizontally (row 2, column 2)
    if [ $count -ge 5 ]; then
        local badge4=$(truncate_badge "${names[4]}")
        local color4=$(get_project_color 4)
        SCRIPT+="
        tell session2
            set session5 to (split horizontally with profile \"$PROFILE_NAME\")
        end tell
        tell session5
            write text \"cd '${projects[4]}' && claude $CLAUDE_ARGS\"
            set name to \"○ ${names[4]}\"
            set background color to $color4
            set variable named \"user.badge\" to \"$badge4\"
        end tell"
    fi

    # Pane 6: split pane 3 horizontally (row 2, column 3)
    if [ $count -ge 6 ]; then
        local badge5=$(truncate_badge "${names[5]}")
        local color5=$(get_project_color 5)
        SCRIPT+="
        tell session3
            set session6 to (split horizontally with profile \"$PROFILE_NAME\")
        end tell
        tell session6
            write text \"cd '${projects[5]}' && claude $CLAUDE_ARGS\"
            set name to \"○ ${names[5]}\"
            set background color to $color5
            set variable named \"user.badge\" to \"$badge5\"
        end tell"
    fi

    # Pane 8: split pane 7 horizontally (column 4, bottom)
    if [ $count -ge 8 ]; then
        local badge7=$(truncate_badge "${names[7]}")
        local color7=$(get_project_color 7)
        SCRIPT+="
        tell session7
            set session8 to (split horizontally with profile \"$PROFILE_NAME\")
        end tell
        tell session8
            write text \"cd '${projects[7]}' && claude $CLAUDE_ARGS\"
            set name to \"○ ${names[7]}\"
            set background color to $color7
            set variable named \"user.badge\" to \"$badge7\"
        end tell"
    fi

    SCRIPT+="
    end tell
    return windowId
end tell"

    # Run the AppleScript
    osascript -e "$SCRIPT" 2>/dev/null

    echo "Created Claude HUD grid"
    echo "Sessions:"
    for name in "${PROJECT_NAMES[@]}"; do
        echo "  - $name"
    done
}

#
# MAIN
#
if [ $NUM_PROJECTS -eq 1 ]; then
    run_single_session
else
    run_grid
fi
